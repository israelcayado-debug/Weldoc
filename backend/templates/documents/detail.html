{% extends "base.html" %}

{% block content %}
  <h1>Welding Book: {{ item.title }}</h1>
  <p>Status: {{ item.status }}</p>
  <p>Project: {{ item.project }}</p>
  <p>
    Equipment scope:
    {% if item.equipment %}
      {{ item.equipment.name }}
    {% else %}
      All project equipment
    {% endif %}
  </p>
  <h2>Book composition</h2>
  <ul>
    <li>Welding Map: {{ composition.welding_map_count }}</li>
    <li>Welding List: {{ composition.welding_list_count }}</li>
    <li>WPS (current): {{ composition.wps_count }}</li>
    <li>PQR approved ASME IX (global): {{ composition.pqr_count }}</li>
  </ul>
  <p>
    <a href="/ui/documents/{{ item.id }}/revisions/new/">New revision</a> |
    <a href="/ui/documents/">Back</a>
  </p>
  {% if publish_error == "wps_not_approved" %}
    <p style="color:#b91c1c;">
      Cannot publish Welding Book. All current WPS must be approved first.
      {% if missing_wps %}Pending: {{ missing_wps }}{% endif %}
    </p>
  {% endif %}

  <h2>Revisions</h2>
  <ul>
    {% for rev in revisions %}
      <li>
        {{ rev.revision }} - {{ rev.status }}
        {% if rev.file_path %}
          - <a href="/media/{{ rev.file_path }}">File</a>
        {% endif %}
        {% if rev.status == "draft" %}
          <form method="post" action="/ui/documents/revisions/{{ rev.id }}/submit/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Submit for review</button>
          </form>
        {% endif %}
        {% if rev.status == "draft" or rev.status == "in_review" %}
          <form method="post" action="/ui/documents/revisions/{{ rev.id }}/approve/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Approve</button>
          </form>
          <form method="post" action="/ui/documents/revisions/{{ rev.id }}/reject/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Reject</button>
          </form>
        {% endif %}
        <form method="get" action="/ui/documents/revisions/{{ rev.id }}/approvals/new/" style="display:inline;">
          <button type="submit">Add approver</button>
        </form>
        <form method="get" action="/ui/documents/revisions/{{ rev.id }}/signatures/new/" style="display:inline;">
          <button type="submit">Sign</button>
        </form>
      </li>
    {% empty %}
      <li>No revisions.</li>
    {% endfor %}
  </ul>

  <h2>Approvals</h2>
  <ul>
    {% for approval in approvals %}
      <li>
        {{ approval.document_revision.revision }} - {{ approval.approver }} - {{ approval.status }}
        {% if approval.status == "pending" %}
          <form method="post" action="/ui/documents/approvals/{{ approval.id }}/approve/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Approve</button>
          </form>
          <form method="post" action="/ui/documents/approvals/{{ approval.id }}/reject/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Reject</button>
          </form>
        {% endif %}
      </li>
    {% empty %}
      <li>No approvals.</li>
    {% endfor %}
  </ul>

  <h2>Signatures</h2>
  <ul>
    {% for sig in signatures %}
      <li>{{ sig.document_revision.revision }} - {{ sig.signer }}</li>
    {% empty %}
      <li>No signatures.</li>
    {% endfor %}
  </ul>
{% endblock %}
